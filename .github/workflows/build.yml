name: Build and Test

on:
  push:
    branches: ['**']  # Run on push to any branch
  pull_request:
    branches: ['**']  # Run on PR to any branch

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      # Required for Next.js build
      JWT_SECRET: ${{ secrets.JWT_SECRET || 'test-secret-for-ci-builds-only' }}
      FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY || 'test-key' }}
      COINGECKO_API_KEY: ${{ secrets.COINGECKO_API_KEY || '' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Node.js 22.x
      uses: actions/setup-node@v4
      with:
        node-version: 22.x
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Type check
      run: npm run type-check
      continue-on-error: false

    - name: Lint
      run: npm run lint
      continue-on-error: false

    - name: Build application
      id: build
      run: |
        echo "::group::Building Next.js application"
        npm run build
        echo "::endgroup::"
        echo "build_status=success" >> $GITHUB_OUTPUT
      continue-on-error: false

    - name: Run tests
      if: steps.build.outputs.build_status == 'success'
      run: |
        echo "::group::Running test suite"
        npm test -- --coverage
        echo "::endgroup::"

    - name: Upload coverage reports
      if: steps.build.outputs.build_status == 'success'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage/
        retention-days: 7
